<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Analytics>
    <Name>esb_stat_analytics_per_minute</Name>
    <Script>
        CREATE TEMPORARY TABLE esbServiceStatPerSecond USING CarbonAnalytics
        OPTIONS (tableName "ESB-Stat-per-Second",
        incrementalProcessing "esbServiceStatPerSecond, 60, 2");

        CREATE TEMPORARY TABLE esbServiceStatPerMinute USING CarbonAnalytics
        OPTIONS (tableName "ESB-Stat-per-Minute",
        schema "year INT -i, month INT -i, day INT -i, hour INT -i, minute INT -i, componentId FACET -i,
        hashCode FACET -i, componentName FACET -i, componentType FACET -i, totalDuration LONG, minDuration INT,
        maxDuration INT, noOfInvocation LONG -sp, faultCount INT, startingTime LONG -i, facetStartTime FACET -i,
        entryPoint FACET -i, entryPointHashcode FACET -i, _timestamp  LONG -i",
        primaryKeys "year, month, day, hour, minute, hashCode, componentId, componentType",
        mergeSchema "false");

        INSERT INTO TABLE esbServiceStatPerMinute
        SELECT year, month, day, hour, minute, componentId, hashCode, componentName, componentType,
        sum(totalDuration) as totalDuration, min(minDuration) as minDuration, max(maxDuration) as maxDuration,
        sum(noOfInvocation) as noOfInvocation, sum(faultCount) as totalFault,
        getMinuteStartingTime(year, month, day, hour, minute) as startingTime,
        cast(getMinuteStartingTime(year, month, day, hour, minute) as STRING) as facetStartTime,
        entryPoint, entryPointHashcode, getMinuteStartingTime(year, month, day, hour, minute) as _timestamp
        FROM esbServiceStatPerSecond
        GROUP BY
        year, month, day, hour, minute, componentId, componentName, componentType, entryPoint, hashCode,
        entryPointHashcode;

        INCREMENTAL_TABLE_COMMIT esbServiceStatPerSecond;

        CREATE TEMPORARY TABLE mediatorStatPerSecond USING CarbonAnalytics
        OPTIONS (tableName "mediator-stat-per-second",
        incrementalProcessing "mediatorStatPerSecond, 60, 2");

        CREATE TEMPORARY TABLE mediatorStatPerMinute USING CarbonAnalytics
        OPTIONS (tableName "mediator-stat-per-minute",
        schema "year INT -i, month INT -i, day INT -i, hour INT -I, minute INT -i, entryPoint FACET -i,
        entryPointHashcode FACET -i, componentIndex INT, componentId FACET -i, hashCode FACET -i,
        componentName FACET -i, componentType FACET -i, totalDuration LONG, minDuration INT, maxDuration INT,
        noOfInvocation LONG -sp, faultCount INT, startingTime LONG -i, facetStartTime FACET -i, _timestamp  LONG -i",
        primaryKeys "year, month, day, hour, minute, entryPointHashcode, hashCode, componentId, componentType",
        mergeSchema "false");

        INSERT INTO TABLE mediatorStatPerMinute
        SELECT year, month, day, hour, minute, entryPoint, entryPointHashcode, componentIndex, componentId, hashCode,
        componentName, componentType, sum(totalDuration) as totalDuration, min(minDuration) as minDuration,
        max(maxDuration) as maxDuration, sum(noOfInvocation) as noOfInvocation, sum(faultCount) as totalFault,
        getMinuteStartingTime(year, month, day, hour, minute) as startingTime,
        cast(getMinuteStartingTime(year, month, day, hour, minute) as STRING) as facetStartTime,
        getMinuteStartingTime(year, month, day, hour, minute) as _timestamp
        FROM mediatorStatPerSecond
        GROUP BY year, month, day, hour, minute, entryPoint, entryPointHashcode, componentIndex, componentId, hashCode,
        componentName, componentType;

        INCREMENTAL_TABLE_COMMIT mediatorStatPerSecond;
    </Script>
    <CronExpression>15 0/2 * * * ?</CronExpression>
</Analytics>
