<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Analytics>
    <Name>esb_stat_analytics_per_hour</Name>
    <Script>
        CREATE TEMPORARY TABLE esbServiceStatPerMinute USING CarbonAnalytics
        OPTIONS (tableName "ESB-Stat-per-Minute");

        CREATE TEMPORARY TABLE esbServiceStatPerHour USING CarbonAnalytics
        OPTIONS (tableName "ESB-Stat-per-Hour",
        schema "year INT -i, month INT -i, day INT -i, hour INT -I, componentId FACET -i, hashCode FACET -i,
        componentName FACET -i, componentType FACET -i, totalDuration LONG, minDuration INT, maxDuration INT,
        noOfInvocation LONG -sp, faultCount INT, startingTime LONG -i, facetStartTime FACET -i, entryPoint FACET -i,
        entryPointHashcode FACET -i, _timestamp  LONG -i",
        primaryKeys "year, month, day, hour, hashCode, componentId, componentType",
        mergeSchema "false");

        INSERT INTO TABLE esbServiceStatPerHour
        SELECT year, month, day, hour, componentId, hashCode, componentName, componentType,
        sum(totalDuration) as totalDuration, min(minDuration) as minDuration, max(maxDuration) as maxDuration,
        sum(noOfInvocation) as noOfInvocation, sum(faultCount) as totalFault,
        getHourStartingTime(year, month, day, hour) as startingTime,
        cast(getHourStartingTime(year, month, day, hour) as STRING) as facetStartTime, entryPoint, entryPointHashcode,
        getHourStartingTime(year, month, day, hour) as _timestamp
        FROM esbServiceStatPerMinute
        GROUP BY
        year, month, day, hour, componentId, hashCode, componentName, componentType, entryPoint, entryPointHashcode;

        CREATE TEMPORARY TABLE mediatorStatPerMinute USING CarbonAnalytics
        OPTIONS (tableName "mediator-stat-per-minute");

        CREATE TEMPORARY TABLE mediatorStatPerHour USING CarbonAnalytics
        OPTIONS (tableName "mediator-stat-per-hour",
        schema "year INT -i, month INT -i, day INT -i, hour INT -I, entryPoint FACET -i, entryPointHashcode FACET -i,
        componentIndex INT, componentId FACET -i,
        hashCode FACET -i, componentName FACET -i, componentType FACET -i, totalDuration LONG, minDuration INT,
        maxDuration INT, noOfInvocation LONG -sp, faultCount INT, startingTime LONG -i, facetStartTime FACET -i, 
         _timestamp  LONG -i",
        primaryKeys "year, month, day, hour, entryPointHashcode, hashCode, componentId, componentType",
        mergeSchema "false");

        INSERT INTO TABLE mediatorStatPerHour
        SELECT year, month, day, hour, entryPoint, entryPointHashcode, componentIndex, componentId, hashCode,
        componentName, componentType, sum(totalDuration) as totalDuration, min(minDuration) as minDuration,
        max(maxDuration) as maxDuration, sum(noOfInvocation) as noOfInvocation, sum(faultCount) as totalFault,
        getHourStartingTime(year, month, day, hour) as startingTime,
        cast(getHourStartingTime(year, month, day, hour) as STRING) as facetStartTime,
        getHourStartingTime(year, month, day, hour) as _timestamp
        FROM mediatorStatPerMinute
        GROUP BY year, month, day, hour, entryPoint, entryPointHashcode, componentIndex, componentId, hashCode,
        componentName, componentType;
    </Script>
    <CronExpression>31 4/14 * * * ?</CronExpression>
</Analytics>
